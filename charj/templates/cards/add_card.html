{% extends "base.html" %}

{% load static %}

{% block title %}
  Add Card
{% endblock title %}
{% block content %}
  <div class="container mt-4">
    <div class="row justify-content-center">
      <div class="col-md-6 col-lg-5">
        <h2 class="mb-4">Add Credit Card</h2>
        <!-- Pricing Summary -->
        <div class="card border-0 shadow-sm mb-4">
          <div class="card-body p-4">
            <div class="d-flex justify-content-between align-items-center mb-3">
              <div>
                <div class="text-muted small mb-1">Charged today</div>
                <div class="h2 mb-0 fw-bold">$1</div>
              </div>
              <div class="text-end">
                <div class="text-muted small mb-1">Then annually</div>
                <div class="h2 mb-0 fw-bold">
                  $1<span class="h6 text-muted fw-normal">/year</span>
                </div>
              </div>
            </div>
            <div class="border-top pt-3">
              <div class="small text-muted mb-2">
                <div class="mb-1">âœ“ Cancel anytime - no future charges</div>
                <div class="mb-1">âœ“ Each card gets its own subscription</div>
                <div>âœ“ Keeps your card active and prevents closure</div>
              </div>
            </div>
          </div>
        </div>
        <!-- Card Form -->
        <div id="card-errors" class="alert alert-danger d-none mb-3" role="alert"></div>
        <div id="card-success"
             class="alert alert-success d-none mb-3"
             role="alert"></div>
        <form id="payment-form">
          {% csrf_token %}
          <div class="mb-3">
            <label for="card-element" class="form-label fw-semibold">Card details</label>
            <div id="card-element" class="form-control">
              <!-- Stripe Elements will be inserted here -->
            </div>
          </div>
          <button id="submit-button"
                  class="btn btn-primary btn-lg w-100 mb-3"
                  type="submit">
            <span id="button-text">Pay $1 & Add Card</span>
            <span id="spinner"
                  class="spinner-border spinner-border-sm d-none ms-2"
                  role="status"
                  aria-hidden="true"></span>
          </button>
        </form>
        <!-- Trust Indicators -->
        <div class="text-center">
          <div class="small text-muted">
            <span class="me-2">ðŸ”’ Secured by Stripe</span>
            <span>â€¢ PCI Compliant</span>
          </div>
          <div class="small text-muted mt-1">Your card details are handled securely</div>
        </div>
        <!-- Auto-pay Recommendation -->
        <div class="alert alert-light border mt-4 mb-0">
          <div class="small">
            <strong class="text-body">ðŸ’¡ Pro tip:</strong>
            <span class="text-muted">Set up auto-pay on your card to avoid late fees. Set it and forget it.</span>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock content %}
{% block inline_javascript %}
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    const stripe = Stripe('{{ stripe_public_key }}');
    const elements = stripe.elements();

    const cardElement = elements.create('card', {
      style: {
        base: {
          fontSize: '16px',
          color: '#32325d',
          fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
          '::placeholder': {
            color: '#aab7c4'
          }
        },
        invalid: {
          color: '#fa755a',
          iconColor: '#fa755a'
        }
      }
    });

    cardElement.mount('#card-element');

    cardElement.addEventListener('change', function(event) {
      if (event.error) {
        showError(event.error.message);
      } else {
        document.getElementById('card-errors').classList.add('d-none');
      }
    });

    // Calculate and display next charge date on page load
    document.addEventListener('DOMContentLoaded', function() {
      const nextYear = new Date();
      nextYear.setFullYear(nextYear.getFullYear() + 1);

      const formattedShort = nextYear.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });

      // Store for success message
      window.nextChargeDateFormatted = formattedShort;
    });

    document.getElementById('payment-form').addEventListener('submit', async function(event) {
      event.preventDefault();
      setLoading(true);

      try {
        // Step 1: Create SetupIntent
        const setupIntentResponse = await fetch('{% url "cards:create_setup_intent" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          }
        });

        if (!setupIntentResponse.ok) {
          const errorData = await setupIntentResponse.json();
          throw new Error(errorData.error || 'Failed to initialize payment setup');
        }

        const {
          clientSecret
        } = await setupIntentResponse.json();

        // Step 2: Confirm card setup with Stripe (handles 3D Secure)
        const {
          setupIntent,
          error
        } = await stripe.confirmCardSetup(clientSecret, {
          payment_method: {
            card: cardElement
          }
        });

        if (error) throw new Error(error.message);

        // Step 3: Create subscription
        const subscriptionResponse = await fetch('{% url "cards:create_subscription" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          },
          body: JSON.stringify({
            payment_method_id: setupIntent.payment_method
          })
        });

        if (!subscriptionResponse.ok) {
          const errorData = await subscriptionResponse.json();
          throw new Error(errorData.error || 'Failed to create subscription');
        }

        // Success! Show message with charge details
        const nextChargeDate = window.nextChargeDateFormatted || 'in 1 year';
        showSuccess(
          `âœ… Card added successfully! You've been charged $1 today. Next charge: ${nextChargeDate}. Redirecting...`
        );

        setTimeout(() => {
          window.location.href = '{% url "cards:dashboard" %}';
        }, 3000);

      } catch (error) {
        console.error('Error:', error);
        showError(error.message);
        setLoading(false);
      }
    });

    function setLoading(isLoading) {
      const submitButton = document.getElementById('submit-button');
      const buttonText = document.getElementById('button-text');
      const spinner = document.getElementById('spinner');

      submitButton.disabled = isLoading;
      buttonText.textContent = isLoading ? 'Processing...' : 'Pay $1 & Add Card';
      if (isLoading) {
        spinner.classList.remove('d-none');
      } else {
        spinner.classList.add('d-none');
      }
    }

    function showError(message) {
      const errorDiv = document.getElementById('card-errors');
      const successDiv = document.getElementById('card-success');
      successDiv.classList.add('d-none');
      errorDiv.textContent = message;
      errorDiv.classList.remove('d-none');
      errorDiv.scrollIntoView({
        behavior: 'smooth',
        block: 'nearest'
      });
    }

    function showSuccess(message) {
      const errorDiv = document.getElementById('card-errors');
      const successDiv = document.getElementById('card-success');
      errorDiv.classList.add('d-none');
      successDiv.textContent = message;
      successDiv.classList.remove('d-none');
      successDiv.scrollIntoView({
        behavior: 'smooth',
        block: 'nearest'
      });
    }

    function getCsrfToken() {
      return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
  </script>
{% endblock inline_javascript %}
