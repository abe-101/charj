{% extends "base.html" %}

{% load static %}

{% block title %}
  Add Card
{% endblock title %}
{% block content %}
  <style>
    .hidden {
      display: none;
    }

    #card-element {
      height: 40px;
      padding-top: 10px;
    }

    .charge-breakdown {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .charge-item {
      flex: 1;
      padding: 1rem;
      background: white;
      border-radius: 8px;
      border: 1px solid #e9ecef;
    }

    .charge-label {
      font-size: 0.875rem;
      color: #6c757d;
      display: block;
      margin-bottom: 0.25rem;
    }

    .charge-amount {
      font-size: 1.75rem;
      font-weight: 700;
      color: #212529;
      margin: 0;
    }
  </style>
  <div class="container mt-4">
    <div class="row justify-content-center">
      <div class="col-md-7">
        <h2 class="mb-4">Add Credit Card</h2>
        <!-- What You'll Be Charged Panel -->
        <div class="alert alert-info border-primary mb-4">
          <h5 class="alert-heading mb-3">ðŸ’³ What You'll Be Charged</h5>
          <div class="charge-breakdown">
            <div class="charge-item">
              <span class="charge-label">Today</span>
              <h3 class="charge-amount">$1</h3>
            </div>
            <div class="charge-item">
              <span class="charge-label">Next Charge</span>
              <h3 class="charge-amount" id="next-charge-display">$1 in 1 year</h3>
              <small class="text-muted" id="next-charge-date"></small>
            </div>
          </div>
          <hr class="my-3" />
          <ul class="mb-2 small">
            <li class="mb-1">âœ… Cancel anytime - no future charges</li>
            <li class="mb-1">âœ… Each card has its own subscription</li>
            <li class="mb-1">âœ… Keeps cards active, prevents closure</li>
          </ul>
          <div class="alert alert-warning mb-0 small py-2">
            <strong>ðŸ’¡ Recommended:</strong> Enable auto-pay on your card to ensure uninterrupted service. Most banks let you set this up online or in their app.
          </div>
        </div>
        <!-- Alerts -->
        <div id="card-errors" class="alert alert-danger hidden" role="alert"></div>
        <div id="card-success" class="alert alert-success hidden" role="alert"></div>
        <!-- Payment Form -->
        <form id="payment-form">
          {% csrf_token %}
          <div class="mb-3">
            <label for="card-element" class="form-label fw-bold">Credit or debit card</label>
            <div id="card-element" class="form-control">
              <!-- Stripe Elements will be inserted here -->
            </div>
          </div>
          <button id="submit-button" class="btn btn-primary w-100" type="submit">
            <span id="button-text">Add Card & Pay $1</span>
            <span id="spinner"
                  class="spinner-border spinner-border-sm hidden"
                  role="status"
                  aria-hidden="true"></span>
          </button>
        </form>
        <!-- Trust Badges -->
        <div class="text-center mt-4">
          <small class="text-muted">
            ðŸ”’ Secured by Stripe â€¢ PCI Compliant
            <br />
            Your card details never touch our servers
          </small>
        </div>
      </div>
    </div>
  </div>
{% endblock content %}
{% block inline_javascript %}
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    const stripe = Stripe('{{ stripe_public_key }}');
    const elements = stripe.elements();

    const cardElement = elements.create('card', {
      style: {
        base: {
          fontSize: '16px',
          color: '#32325d',
          fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
          '::placeholder': {
            color: '#aab7c4'
          }
        },
        invalid: {
          color: '#fa755a',
          iconColor: '#fa755a'
        }
      }
    });

    cardElement.mount('#card-element');

    cardElement.addEventListener('change', function(event) {
      if (event.error) {
        showError(event.error.message);
      } else {
        document.getElementById('card-errors').classList.add('hidden');
      }
    });

    // Calculate and display next charge date on page load
    document.addEventListener('DOMContentLoaded', function() {
      const nextYear = new Date();
      nextYear.setFullYear(nextYear.getFullYear() + 1);

      const formattedLong = nextYear.toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric'
      });

      const formattedShort = nextYear.toLocaleDateString('en-US', {
        month: 'short',
        day: 'numeric',
        year: 'numeric'
      });

      const displayEl = document.getElementById('next-charge-display');
      const dateEl = document.getElementById('next-charge-date');

      if (displayEl) {
        displayEl.textContent = '$1';
      }
      if (dateEl) {
        dateEl.textContent = formattedLong;
      }

      // Store for success message
      window.nextChargeDateFormatted = formattedShort;
    });

    document.getElementById('payment-form').addEventListener('submit', async function(event) {
      event.preventDefault();
      setLoading(true);

      try {
        // Step 1: Create SetupIntent
        const setupIntentResponse = await fetch('{% url "cards:create_setup_intent" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          }
        });

        if (!setupIntentResponse.ok) {
          const errorData = await setupIntentResponse.json();
          throw new Error(errorData.error || 'Failed to initialize payment setup');
        }

        const {
          clientSecret
        } = await setupIntentResponse.json();

        // Step 2: Confirm card setup with Stripe (handles 3D Secure)
        const {
          setupIntent,
          error
        } = await stripe.confirmCardSetup(clientSecret, {
          payment_method: {
            card: cardElement
          }
        });

        if (error) throw new Error(error.message);

        // Step 3: Create subscription
        const subscriptionResponse = await fetch('{% url "cards:create_subscription" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          },
          body: JSON.stringify({
            payment_method_id: setupIntent.payment_method
          })
        });

        if (!subscriptionResponse.ok) {
          const errorData = await subscriptionResponse.json();
          throw new Error(errorData.error || 'Failed to create subscription');
        }

        // Success! Show message with charge details
        const nextChargeDate = window.nextChargeDateFormatted || 'in 1 year';
        showSuccess(
          `âœ… Card added successfully! You've been charged $1 today. Next charge: ${nextChargeDate}. Redirecting...`
        );

        setTimeout(() => {
          window.location.href = '{% url "cards:dashboard" %}';
        }, 3000);

      } catch (error) {
        console.error('Error:', error);
        showError(error.message);
        setLoading(false);
      }
    });

    function setLoading(isLoading) {
      const submitButton = document.getElementById('submit-button');
      const buttonText = document.getElementById('button-text');
      const spinner = document.getElementById('spinner');

      submitButton.disabled = isLoading;
      buttonText.textContent = isLoading ? 'Processing...' : 'Add Card & Pay $1';
      if (isLoading) {
        spinner.classList.remove('hidden');
      } else {
        spinner.classList.add('hidden');
      }
    }

    function showError(message) {
      const errorDiv = document.getElementById('card-errors');
      const successDiv = document.getElementById('card-success');
      successDiv.classList.add('hidden');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      errorDiv.scrollIntoView({
        behavior: 'smooth',
        block: 'nearest'
      });
    }

    function showSuccess(message) {
      const errorDiv = document.getElementById('card-errors');
      const successDiv = document.getElementById('card-success');
      errorDiv.classList.add('hidden');
      successDiv.textContent = message;
      successDiv.classList.remove('hidden');
      successDiv.scrollIntoView({
        behavior: 'smooth',
        block: 'nearest'
      });
    }

    function getCsrfToken() {
      return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
  </script>
{% endblock inline_javascript %}
