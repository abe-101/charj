{% extends "base.html" %}

{% load static %}

{% block title %}
  Add Card
{% endblock title %}
{% block content %}
  <style>
    .hidden {
      display: none;
    }

    #card-element {
      height: 40px;
      padding-top: 10px;
    }
  </style>
  <div class="container mt-4">
    <div class="row justify-content-center">
      <div class="col-md-6">
        <h2 class="mb-4">Add Credit Card</h2>
        <div id="card-errors" class="alert alert-danger hidden" role="alert"></div>
        <div id="card-success" class="alert alert-success hidden" role="alert"></div>
        <form id="payment-form">
          {% csrf_token %}
          <div class="mb-3">
            <label for="card-element" class="form-label">Credit or debit card</label>
            <div id="card-element" class="form-control">
              <!-- Stripe Elements will be inserted here -->
            </div>
          </div>
          <button id="submit-button" class="btn btn-primary w-100" type="submit">
            <span id="button-text">Add Card</span>
            <span id="spinner"
                  class="spinner-border spinner-border-sm hidden"
                  role="status"
                  aria-hidden="true"></span>
          </button>
          <p class="mt-3 text-muted small">This will create an annual $1 subscription to keep your card active.</p>
        </form>
      </div>
    </div>
  </div>
{% endblock content %}
{% block inline_javascript %}
  <script src="https://js.stripe.com/v3/"></script>
  <script>
    const stripe = Stripe('{{ stripe_public_key }}');
    const elements = stripe.elements();

    const cardElement = elements.create('card', {
      style: {
        base: {
          fontSize: '16px',
          color: '#32325d',
          fontFamily: '-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif',
          '::placeholder': {
            color: '#aab7c4'
          }
        },
        invalid: {
          color: '#fa755a',
          iconColor: '#fa755a'
        }
      }
    });

    cardElement.mount('#card-element');

    cardElement.addEventListener('change', function(event) {
      if (event.error) {
        showError(event.error.message);
      } else {
        document.getElementById('card-errors').classList.add('hidden');
      }
    });

    document.getElementById('payment-form').addEventListener('submit', async function(event) {
      event.preventDefault();
      setLoading(true);

      try {
        // Step 1: Create SetupIntent
        const setupIntentResponse = await fetch('{% url "cards:create_setup_intent" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          }
        });

        if (!setupIntentResponse.ok) {
          const errorData = await setupIntentResponse.json();
          throw new Error(errorData.error || 'Failed to initialize payment setup');
        }

        const {
          clientSecret
        } = await setupIntentResponse.json();

        // Step 2: Confirm card setup with Stripe (handles 3D Secure)
        const {
          setupIntent,
          error
        } = await stripe.confirmCardSetup(clientSecret, {
          payment_method: {
            card: cardElement
          }
        });

        if (error) throw new Error(error.message);

        // Step 3: Create subscription
        const subscriptionResponse = await fetch('{% url "cards:create_subscription" %}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'X-CSRFToken': getCsrfToken()
          },
          body: JSON.stringify({
            payment_method_id: setupIntent.payment_method
          })
        });

        if (!subscriptionResponse.ok) {
          const errorData = await subscriptionResponse.json();
          throw new Error(errorData.error || 'Failed to create subscription');
        }

        showSuccess('Card added successfully! Redirecting...');
        setTimeout(() => {
          window.location.href = '{% url "users:detail" request.user.pk %}';
        }, 2000);

      } catch (error) {
        console.error('Error:', error);
        showError(error.message);
        setLoading(false);
      }
    });

    function setLoading(isLoading) {
      const submitButton = document.getElementById('submit-button');
      const buttonText = document.getElementById('button-text');
      const spinner = document.getElementById('spinner');

      submitButton.disabled = isLoading;
      buttonText.textContent = isLoading ? 'Processing...' : 'Add Card';
      if (isLoading) {
        spinner.classList.remove('hidden');
      } else {
        spinner.classList.add('hidden');
      }
    }

    function showError(message) {
      const errorDiv = document.getElementById('card-errors');
      const successDiv = document.getElementById('card-success');
      successDiv.classList.add('hidden');
      errorDiv.textContent = message;
      errorDiv.classList.remove('hidden');
      errorDiv.scrollIntoView({
        behavior: 'smooth',
        block: 'nearest'
      });
    }

    function showSuccess(message) {
      const errorDiv = document.getElementById('card-errors');
      const successDiv = document.getElementById('card-success');
      errorDiv.classList.add('hidden');
      successDiv.textContent = message;
      successDiv.classList.remove('hidden');
      successDiv.scrollIntoView({
        behavior: 'smooth',
        block: 'nearest'
      });
    }

    function getCsrfToken() {
      return document.querySelector('[name=csrfmiddlewaretoken]').value;
    }
  </script>
{% endblock inline_javascript %}
